# JAVA内q区域与内存溢出

## 运行时数据区域

java虚拟机在执行java程序的过程中会把它管理的内存划分为若干不同的数据区域。这些区域有各自用途和创建，销毁的时间。

![运行时数据区](https://raw.githubusercontent.com/Markkkkks/Photoes/master/jvmdata.png)

### 1.1程序计数器

特点：线程共享，虚拟机规范中唯一没有规定任何`OutofMemoryError`情况的区域

功能：可以看作当前程序所执行的字节码的行号指示器。通过改变这个计数器的值选取吓一跳需要执行的字节码指令，分支循环跳转异常处理，线程恢复等基础功能都需要依赖这个计数器来完成。

### 1.2JAVA虚拟机栈

特点：线程私有

包含： 局部变量表，操作数栈，动态链接，方法出口

功能：局部变量表存放编译器可知的(int等)各种基本数据类型、对象引用，其中double与long类型数据会占用两个局部空间，其他占一个。一个方法的局部变量空间是完全确定的。

异常：请求栈深度过深`StackOverflowError`；虚拟机栈若可以动态扩展，可造成`OutOfMemoryError`;

### 1.3本地方法栈

与虚拟机栈类似，区别为服务对象是虚拟机用到的native方法。

异常：`StackOverflowError`,`OutOfMemoryError`;

### 1.4JAVA堆

特点：线程共享

功能：存放对象实例和数组，是垃圾回收的主要管理区域。可处于物理上不连续的内存空间中。

### 1.5方法区

特点：线程共享

功能：用于储存已经被虚拟机加载的类信息，常量，静态变量，即时编译器编译后的代码数据等。

### 1.6运行时常量池

方法区中的一部分，Class文件除了类版本，字段，方法接口等描述信息外，还有一项信息是常量池，用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法去的运行时常量池。

常量池中还可能存放运行期间产生的新的常量如String的intern()方法。

异常：`OutOfMemoryError`异常

### 1.7直接内存

由于java加入的NIO类引入了一种基于通道Channel与缓冲区的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过DirectByteBuffer对象作为这块内存的引用进行操作。

该部分内存分配不受堆大小的限制，但是会受到本机内存和处理器寻址空间的限制。

## 虚拟机对象探秘

### 1.对象的创建

遇到new指令后，第一时间在常量池定位到类的符号引用，如果符号代表的类没被加载、解析、初始化过，执行相应类加载过程。

为新生对象分配内存(基于不同垃圾回收机制对堆中内存的管理是否零散)

对对象进行必要的设置(在下一点中进行解析)

#### 2.对象的内存布局

分区域：对象头，示例数据和对齐填充

对象头：

（运行时数据）包含自身运行时数据如HashCode、GC分代年龄\锁状态标志、县城持有的锁、偏向线程ID，偏向时间戳等。内存大小常为不固定。

(类型指针) 指向类元数据的指针，虚拟机通过该指针确定对象是那个类的实例。如果是

实例数据：字段内容，一般情况先父类后子类，分配策略：longs/doubles,ints,shorts/char,bytes/booleans,oops

对齐填充：对象大小必须是8字节的整数倍，不够就有填充

### 3.对象的访问定位

1. 本地变量表（在栈中）的reference->句柄池->实例池和方法区
1. reference->堆中地址（包含类指针）->类指针指向方法区

优缺点：句柄：reference中保存的是稳定句柄地址，对象被移动只会改变句柄中的指针；直接指针访问：速度快，节省了一次指针定位时间开销。

## OutOfMemory异常

### 1.Java堆溢出

堆大小的确定 参数`-Xms20m -Xmx20m`确定堆大小，`-XX:HeapDumpOnOutOfMemoryError`出现内存溢出一场时Dump出内存堆快照

异常信息：`JAva heap spase`

出现原因：堆中太多对象

### 2.虚拟机栈和本地方法栈溢出

栈大小设置：`-Xss128k`

1. 通过限制栈大小，并重复递归可实现`StackOverflowError`
1. java堆与方法区内存最大值可以设置，计算机最大内存减去Xmx(最大堆容量),再减去MaxPermSize(最大方法区容量)，剩下内存被虚拟机栈和本地方法栈瓜分。

### 3.方法区与运行时常量池溢出

方法区大小设置：`-XX:PermSize`和`-XX:MaxPermSize`

通过String.intern塞满运行时常量池实现运行时常量池溢出`PermGen space`

ps: JDK1.6 StringBuilder创建的字符串实例在堆中；JDK1.7及以后的intern函数不会复制实例而是常量池中记录首次出现的实例。

### 4.本机直接内存溢出

大小设置： `-XX:MaxDirectMemorySize=10M`

方法：通过获取Unsafe然后死循环分配内存。
